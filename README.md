# Di0Zone проект

Проект предназначен для автоматизации рутинных повседневных задач. Основной из них является поддержание рабочего окружения в актуальном состоянии в условиях, когда приходится работать на нескольких рабочих местах, кочуя от одного к другому.

Установка производится в домашний каталог пользователя в следующие подкаталоги:

- `${HOME}/.local/share/Di0Zone/bin` - исполняемые скрипты;
- `${HOME}/.local/share/Di0Zone/lib` - файлы библиотек;
- `${HOME}/.config/Di0Zone` - файлы конфигурации;
- `${HOME}/.local/share/applications` - файлы Desktop Entry File;
- `${HOME}/.local/share/icons` - файлы пиктограмм для Desktop Entry File;
- `${HOME}/.local/share/systemd/user` - файлы Systemd;
- `${HOME}/.local/state/Di0Zone` - файлы, образующиеся в процессе работы скриптов (логи, резервные копии удалённых файлов).

Все файлы проекта (за исключением тех, которые идут на подмену файлов из других проектов) имеют приставку "dz\_", по которой их легко распознать и, при необходимости, вычистить из системы.

Для исполняемых файлов в каталоге `${HOME}/.local/bin` создаются символические ссылки, по которым их можно запускать на исполнение. Необходимо проследить, что бы данный каталог находился в переменной `${PATH}` окружения пользователя.

Проект работает в окружении пользователя. В проекте задействованы механизмы freedesktop.org и systemd. Необходим установленный терминал xterm, Rsync, клиент SSH и сервер с доступом по SSH.

Проект состоит из нескольких компонентов, описанных ниже.

## Компонент DZ_SYNC

Данный компонент является надстройкой над хорошо известной в мире Linux утилитой копирования файлов Rsync.

Основная задача данного компонента - поддержание в актуальном состоянии своего рабочего окружения (по-умолчанию, внутри домашнего каталога) на нескольких компьютерах сразу. Так, например, мне приходится работать на 5-ти рабочих местах. И хотелось бы, что бы мои рабочие файлы, при переходе с места на место, приводились в идентичное состояние. Т.е., если я сделал какие-либо изменения на одном рабочем месте, то должен быть механизм, который эти изменения перенесёт на другое рабочее место, при переходе на него. Этим и занимается данный компонент проекта.

Синхронизация данных производится посредством сервера, который хранит текущее состояние рабочего окружения. Доступ к серверу осуществляется по протоколу SSH. На сервере для размещения синхронизируемых каталогов должен быть доступен для записи каталог `/srv/rsync/dz_sync`.

Начало работы на каждом рабочем месте начинается с загрузки изменений в рабочем окружении с сервера, которые были сделаны перед уходом с другого рабочего места. По окончании работы, все сделанные изменения переносятся на сервер, и работа на другом месте начинается с их загрузки, приведя рабочее окружение в то состояние, в котором оно было оставлено на предыдущем рабочем месте.

Компонент состоит из скрипта `dz_sync.sh` и конфигурационного файла `dz_sync.conf`. Будучи запущенным, скрипт самостоятельно определяет с какого компьютера были сделаны последние изменения на сервере, и, в зависимости от этого, выбирает, следует забрать их (PULL) или отправить (PUSH). Удобство использования утилиты Rsync в том, что она самостоятельно определяет изменения в файлах и осуществляет передачу только тех, которые претерпели изменения, что значительно снижает трафик и время, затрачиваемое на синхронизацию данных.

Список каталогов, подлежащих синхронизации, `dz_sync.sh` получает из конфигурационного файла (массив SYNC_LIST) или из командной строки. В каждом каталоге, отправленном на сервер, на стороне сервера создаётся файл `.dz_sync`, в котором записана информация об имени узла, с которого производилась последняя синхронизация, время и направление синхронизации.

Для утилиты `dz_sync.sh` в каталоге `${HOME}/.local/bin` создаётся, помимо прямой ссылки, ещё две ссылки - `dz_sync_pull.sh` и `dz_sync_push.sh`, используя которые, можно самостоятельно задать конкретное направление синхронизации.

Работа компонента не ограничивается только синхронизацией каталогов внутри рабочего окружения. Можно сохранять каталоги и вне его, указав их в командной строке, например системные настройки из `/etc`. Главное условие, у пользователя должны быть права на чтение сохраняемой информации. Необходимо иметь ввиду разное поведение компонента с каталогами, находящимися внутри рабочего окружения и вне его. Для первых выполняется весь комплекс синхронизации, как автоматическое определение направления, загрузка на сервер, получение с него. Каталоги же за пределами рабочего окружения могут быть только загружены на сервер. При этом на сервере они помещаются в отдельный каталог `_ext/имя_компьютера`. Обратная загрузка с сервера запрещена. Это предохраняет файлы от изменения средствами данного компонента, что может быть опасно -- ну давайте попереназапиcываем файлы, например, в каталоге `/etc`. Не думаю, что из этого получится что-то хорошее. В лучшем случае система разграничения доступа не позволит этого сделать, в худшем можно привести систему в нерабочее состояние.

При синхронизации не происходит безвозвратной потери стёртых в рабочем окружении файлов. Все стёртые файлы помещаются на стороне клиента в каталог `${HOME}/.local/state/Di0Zone/dz_sync.trash`, на стороне сервера в каталог `/srv/rsync/dz_sync/_trash`. В ходе работы компонента, для исключения их переполнения, происходит удаление каталогов старше указанного в параметре TRASH_AGE количества дней.

> [!NOTE]
> Адреса сервера хранятся в конфигурационном файле в массиве SERVER_ADDRESSES. Несмотря на то, что туда можно включить несколько адресов, сервер должен быть один!!! Возможность включения нескольких адресов предусмотрена для тех случаев, когда сервер доступен по нескольким адресам. Так, например, из домашней сети он виден под одним, из Интернета, под другим, а через какой-нибудь VPN появляется уже третий адрес.

Синтаксис:

    dz_sync.sh [<каталог1>[ <каталог2>]...]

Этому скрипту соответствуют desktop-файлы `dz_sync.desktop, dz_sync_pull.desktop, dz_sync_push.desktop` благодаря которым скрипт интегрируется в окружение рабочего стола, и его можно вызывать из контекстного меню файлового менеджера щелчком на каталоге.

При входе пользователя в систему, запуск этого скрипта производится системой Systemd путём запуска таймера dz_project.timer (он выдаёт некоторую задержку запуска), активирующего сервис dz_project.service.

## Компонент DZ_ENCFS

В своей работе я использую Encfs для шифрования каталогов с чувствительной информацией. Данный компонент помогает управлять процессом их расшифровки и монтирования и является надстройкой над утилитой Encfs.

Требования компонента:

- должна быть установлена утилита Encfs;
- зашифрованные каталоги должны быть созданы, и иметь расширение .enc;
- монтирование расшифрованного каталога производится в каталог с тем же именем, но без расширения;
- параметры шифрования должны быть настроены средствами самой EncFS;
- XML файл конфигурации зашифрованного каталога должен храниться отдельно от него, иметь такое же имя, как у каталога, без расширения. Местом хранения файла установлен каталог `${HOME}/.ssh/encfs`.

При передаче скрипту, в качестве параметра, имени зашифрованного каталога, он его расшифрует и смонтирует в каталог (точку монтирования) с таким же именем, но без расширения. В случае же, если каталог уже смонтирован, произойдёт его размонтирование и удаление точки монтирования.

Синтаксис:

    dz_encfs.sh <зашифрованный_каталог.enc>

Так же этому скрипту соответствует desktop-файл `dz_encfs.desktop`, благодаря которому скрипт интегрируется в окружение рабочего стола, в частности, его можно вызывать из контекстного меню файлового менеджера щелчком на каталоге.

## Компонент DZ_SHUTDOWN

Главная цель этого компонента, при завершении работы вызвать компоненты DZ_SYNC для синхронизации рабочего окружения, DZ_ENCFS для размонтирования шифрованных каталогов. Необходимость компонента заключается в том, что, порой, перед выключением компьютера, я забывал это сделать и мог уйти с рабочего места не сделав синхронизации, и, придя на другое, мог только развести руками. Вся сделанная работа оставалась на предыдущем месте и была не доступна на новом.

Вызов скрипта вписан в файл `xfce4-session-logout.desktop`, размещаемого в пользовательском окружении (я работаю в среде XFCE), который подменяет действие аналогичного системного файла XFCE, в результате чего, при вызове пункта меню XFCE "Выйти" вместо штатного скрипта завершения работы XFCE, срабатывает этот компонент.

Синтаксис:

    dz_shutdown.sh
